---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: Backend
metadata:
  name: s3-backend
  namespace: web-demo
spec:
  endpoints:
    - fqdn:
        hostname: ${OBJECT_STORAGE_EXTERNAL_NAME}
        port: 443
  tls:
    sni: ${OBJECT_STORAGE_EXTERNAL_NAME}
    wellKnownCACertificates: System
---
# httproute.yaml - Main domain routing
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: web-route-static
  namespace: web-demo
  annotations:
    # ExternalDNS creates A record for this hostname
    external-dns.alpha.kubernetes.io/hostname: static.${DOMAIN}.
    external-dns.alpha.kubernetes.io/ttl: "300" # 5 minutes
spec:
  parentRefs:
    - name: main-gateway
  hostnames:
    - static.${DOMAIN}
  rules:
    # Serve static assets from the object storage bucket
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        - type: URLRewrite
          urlRewrite:
            hostname: ${OBJECT_STORAGE_EXTERNAL_NAME}
      backendRefs:
        - group: gateway.envoyproxy.io # Important: Specify the group for Backend
          kind: Backend
          name: s3-backend
          port: 80
